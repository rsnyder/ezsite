<template>

  <ul ref="footer" class="flex bg-slate-100 p-2 gap-3 mt-8 items-center w-full h-8">
    <li v-for="li, idx in footerElems" :key="`li-${idx}`" v-html="li.innerHTML" :class="li.className" :style="li.getAttribute('style') || ''"></li>
    <li>
      <a href="javascript:;" @click="generatePDF">
        <svg xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:cc="http://creativecommons.org/ns#" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns:svg="http://www.w3.org/2000/svg" xmlns="http://www.w3.org/2000/svg" xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape" version="1.1" x="0px" y="0px" viewBox="0 0 116 116" enable-background="new 0 0 100 100" xml:space="preserve" id="svg30" sodipodi:docname="noun_117327_cc.svg" width="116" height="116" inkscape:version="0.92.2 5c3e80d, 2017-08-06"><metadata id="metadata36"><rdf:RDF><cc:Work rdf:about=""><dc:format>image/svg+xml</dc:format><dc:type rdf:resource="http://purl.org/dc/dcmitype/StillImage" /><dc:title></dc:title></cc:Work></rdf:RDF></metadata><defs id="defs34" /><sodipodi:namedview pagecolor="#ffffff" bordercolor="#666666"
     borderopacity="1"
     objecttolerance="10"
     gridtolerance="10"
     guidetolerance="10"
     inkscape:pageopacity="0"
     inkscape:pageshadow="2"
     inkscape:window-width="640"
     inkscape:window-height="480"
     id="namedview32"
     showgrid="false"
     fit-margin-top="10"
     fit-margin-left="10"
     fit-margin-right="10"
     fit-margin-bottom="10"
     inkscape:zoom="1.888"
     inkscape:cx="48.5"
     inkscape:cy="45.001"
     inkscape:window-x="0"
     inkscape:window-y="0"
     inkscape:window-maximized="0"
     inkscape:current-layer="svg30" /><g
     id="g24"
     transform="translate(8.5,8.4990005)"><path
       d="m 73.104,64.133 c -1.17,0.345 -2.887,0.384 -4.729,0.117 -1.976,-0.287 -3.992,-0.891 -5.973,-1.781 3.533,-0.514 6.274,-0.356 8.618,0.475 0.556,0.197 1.468,0.723 2.084,1.189 M 53.392,60.892 c -0.144,0.039 -0.285,0.076 -0.426,0.115 -0.951,0.259 -1.876,0.511 -2.767,0.736 l -1.202,0.305 c -2.418,0.612 -4.89,1.237 -7.331,1.981 0.928,-2.238 1.79,-4.5 2.634,-6.712 0.625,-1.637 1.263,-3.31 1.923,-4.961 0.335,0.553 0.684,1.106 1.048,1.661 1.656,2.523 3.738,4.856 6.121,6.875 m -6.15,-25.233 c 0.157,2.761 -0.439,5.417 -1.313,7.965 -1.076,-3.151 -1.578,-6.63 -0.232,-9.439 0.345,-0.72 0.628,-1.105 0.811,-1.306 0.283,0.438 0.656,1.416 0.734,2.78 M 34.62,70.635 c -0.605,1.082 -1.222,2.095 -1.855,3.051 -1.527,2.301 -4.024,4.765 -5.307,4.765 -0.126,0 -0.279,-0.02 -0.502,-0.256 -0.144,-0.151 -0.167,-0.259 -0.16,-0.406 0.043,-0.846 1.164,-2.353 2.788,-3.75 1.474,-1.268 3.14,-2.394 5.036,-3.404 m 42.57,-6.383 c -0.196,-2.818 -4.94,-4.626 -4.987,-4.643 -1.834,-0.65 -3.826,-0.966 -6.09,-0.966 -2.424,0 -5.037,0.351 -8.393,1.135 -2.986,-2.117 -5.566,-4.767 -7.493,-7.701 -0.851,-1.296 -1.616,-2.59 -2.283,-3.854 1.628,-3.893 3.094,-8.079 2.828,-12.767 -0.215,-3.759 -1.91,-6.284 -4.215,-6.284 -1.581,0 -2.943,1.171 -4.05,3.484 -1.975,4.122 -1.456,9.396 1.542,15.689 -1.08,2.536 -2.083,5.165 -3.054,7.711 -1.208,3.165 -2.453,6.43 -3.856,9.536 -3.935,1.557 -7.167,3.445 -9.861,5.763 -1.765,1.516 -3.892,3.833 -4.014,6.252 -0.059,1.139 0.331,2.184 1.125,3.021 0.843,0.889 1.903,1.357 3.068,1.358 3.848,0 7.551,-5.287 8.253,-6.347 1.414,-2.131 2.737,-4.508 4.034,-7.25 3.266,-1.18 6.747,-2.061 10.12,-2.913 l 1.208,-0.307 c 0.908,-0.231 1.852,-0.486 2.82,-0.751 1.025,-0.277 2.079,-0.564 3.15,-0.837 3.464,2.203 7.189,3.64 10.822,4.167 3.06,0.445 5.778,0.187 7.617,-0.772 1.656,-0.862 1.748,-2.192 1.709,-2.724 m 7.452,24.232 c 0,5.161 -4.549,5.479 -5.467,5.49 H 20.488 c -5.142,0 -5.452,-4.58 -5.462,-5.49 V 10.517 c 0,-5.166 4.557,-5.479 5.462,-5.49 h 39.645 l 0.021,0.021 v 15.471 c 0,3.105 1.877,8.983 8.986,8.983 h 15.37 l 0.132,0.132 z M 80.998,25.975 H 69.141 C 64,25.975 63.689,21.42 63.682,20.519 V 8.588 Z m 7.17,62.509 V 28.178 L 63.682,3.59 V 3.476 H 63.565 L 61.599,1.5 H 20.488 C 17.379,1.5 11.5,3.385 11.5,10.517 v 77.968 c 0,3.118 1.879,9.016 8.988,9.016 h 58.693 c 3.108,-0.001 8.987,-1.885 8.987,-9.017"
       id="path22"
       inkscape:connector-curvature="0" /></g></svg>
      </a>
    </li>
  </ul>

</template>
  
<script setup lang="ts">

import { computed, ref, toRaw, watch } from 'vue'

  const props = defineProps({
    sticky: { type: Boolean }
  })

  const footerElems = ref<HTMLLIElement[]>([])

  const footer = ref<HTMLElement | null>(null)
  const host = computed(() => (footer.value?.getRootNode() as any)?.host)

  watch(host, () => { getFooterItems() })

  function getFooterItems() {
    function parseSlot() {
      return Array.from(host.value.querySelectorAll('li') as HTMLUListElement[])
      .map(li => {
        let newLi = document.createElement('li')
        newLi.innerHTML = (li.firstChild as HTMLParagraphElement).innerHTML
        let codeEl = newLi.querySelector('code')
        if (codeEl) {
          let priorEl = codeEl.previousElementSibling
          let target = priorEl ? priorEl : newLi
          let parsed:any = parseCodeEl(codeEl.innerHTML)
          if (parsed.id) target.id = parsed.id
          if (parsed.class) parsed.class.split(' ').forEach(c => target.classList.add(c))
          if (parsed.style) target.setAttribute('style', parsed.style)
          codeEl.remove()
        }
        return newLi
      })
    }
    footerElems.value = parseSlot()
    new MutationObserver(
      (mutationsList:any) => {
        for (let mutation of mutationsList) { if (mutation.type === 'childList') footerElems.value = parseSlot() }      
      }
    ).observe(host.value, { childList: true, subtree: true })
  }

  function parseCodeEl(s:string) {
    let tokens:string[] = []
    s = s.replace(/”/g,'"').replace(/”/g,'"').replace(/’/g,"'")
    s?.match(/[^\s"]+|"([^"]*)"/gmi)?.filter(t => t).forEach((token:string) => {
      if (tokens.length > 0 && tokens[tokens.length-1].indexOf('=') === tokens[tokens.length-1].length-1) tokens[tokens.length-1] = `${tokens[tokens.length-1]}${token}`
      else tokens.push(token)
    })
    let parsed = {}
    let tokenIdx = 0
    while (tokenIdx < tokens.length) {
      let token = tokens[tokenIdx]
      if (token.indexOf('=') > 0) {
        let [key, value] = token.split('=')
        value = value[0] === '"' && value[value.length-1] === '"' ? value.slice(1, -1) : value
        if (parsed[key]) parsed[key] += ` ${value}`
        else parsed[key] = value
      }
      else if (token[0] === '.') {
        let key = 'class'
        let value = token.slice(1)
        value = value[0] === '"' && value[value.length-1] === '"' ? value.slice(1, -1) : value
        if (parsed[key]) parsed[key] += ` ${value}`
        else parsed[key] = value
      }
      else if (token[0] === ':') {
        let key = 'style'
        let value
        if (token.length === 1 && tokenIdx < token.length && tokens[tokenIdx+1][0] === '"') {
          value = tokens[tokenIdx+1].slice(1, -1)
          tokenIdx++
        } else {
          value = token.slice(1)
        }
        if (parsed[key]) parsed[key] += ` ${value}`
        else parsed[key] = value
      }
      else if (token[0] === '"') {
        let key = 'args'
        let value = token.slice(1,-1)
        if (parsed[key]) parsed[key].push(value)
        else parsed[key] = [value]
      }
      else if (token[0] === '#') parsed['id'] = token.slice(1)
      else parsed[token] = true
      tokenIdx++
    }
    return parsed
  }

  function generatePDF() {
    console.log('generatePDF')
    window.open(`https://ezsitepdf-drnxe7pzjq-uc.a.run.app/pdf?url=${location.href}`, '_blank')

  }

</script>

<style>
  @import '../tailwind.css';

img,
svg {
  height: 36px;
  width: 36px;
}

.push {
  margin-left: auto;
}
</style>